// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Game {
  appId              BigInt                   @id @map("app_id")
  name               String

  // Frequently queried fields for filtering and scoring
  releaseYear        Int?                     @map("release_year")
  reviewPositivePct  Int?                     @map("review_positive_pct") // 0-100
  reviewCount        Int?                     @map("review_count")
  isFree             Boolean?                 @map("is_free")
  metacriticScore    Int?                     @map("metacritic_score")
  type               String?                  // game, dlc, demo, etc.

  // Full metadata as JSONB for flexibility
  metadata           Json?                    @db.JsonB

  // Vector embedding for similarity search (OpenAI text-embedding-3-small)
  embedding          Unsupported("vector(1536)")? @map("embedding")

  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")

  // Relations
  userGames          UserGame[]
  userFeedback       UserFeedback[]

  @@map("games")
  @@index([releaseYear])
  @@index([reviewPositivePct])
  @@index([isFree])
  @@index([type])
}

model UserProfile {
  id                 String                   @id @default(cuid())
  steamId            String?                  @unique @map("steam_id") // Steam user ID (optional)
  email              String?                  @unique // From Stripe checkout

  // Personalized recommendation vector (computed from played games)
  preferenceVector   Unsupported("vector(1536)")? @map("preference_vector")

  // Learned vector (dynamically updated from feedback - PREMIUM ONLY)
  learnedVector      Unsupported("vector(1536)")? @map("learned_vector")

  // Subscription tier
  subscriptionTier   String                   @default("free") @map("subscription_tier") // 'free' or 'premium'
  subscriptionExpiresAt DateTime?             @map("subscription_expires_at")

  // Stripe integration
  stripeCustomerId     String?                @unique @map("stripe_customer_id")
  stripeSubscriptionId String?                @unique @map("stripe_subscription_id")

  // Metadata about preference generation
  lastUpdated        DateTime?                @map("last_updated")
  gamesAnalyzed      Int                      @default(0) @map("games_analyzed") // Count of games used
  totalPlaytimeHours Float                    @default(0) @map("total_playtime_hours")

  // Feedback stats
  feedbackLikesCount Int                      @default(0) @map("feedback_likes_count")
  feedbackDislikesCount Int                   @default(0) @map("feedback_dislikes_count")

  // User preferences and filters
  preferences        Json?                    @db.JsonB // Custom user preferences (genres to boost, etc.)

  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")

  // Relations
  games              UserGame[]
  feedback           UserFeedback[]

  @@map("user_profiles")
  @@index([steamId])
  @@index([subscriptionTier])
}

model UserFeedback {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  appId        BigInt       @map("app_id")
  feedbackType String       @map("feedback_type") // 'like', 'dislike', 'not_interested', 'love'

  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  user         UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  game         Game         @relation(fields: [appId], references: [appId], onDelete: Cascade)

  @@unique([userId, appId])
  @@map("user_feedback")
  @@index([userId])
  @@index([appId])
  @@index([feedbackType])
}

model UserGame {
  id                 String                   @id @default(cuid())
  userId             String                   @map("user_id")
  appId              BigInt                   @map("app_id")

  // Playtime data (from Steam API)
  playtimeMinutes    Int                      @map("playtime_minutes") // Total playtime in minutes
  playtimeRecent     Int?                     @map("playtime_recent") // Last 2 weeks playtime (optional)
  lastPlayed         DateTime?                @map("last_played") // Last time game was played

  // Achievement data (optional, for quality signals)
  achievementsEarned Int?                     @map("achievements_earned")
  achievementsTotal  Int?                     @map("achievements_total")

  // Computed weights (cached for performance)
  computedWeight     Float?                   @map("computed_weight") // Overall weight for this game

  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")

  // Relations
  user               UserProfile              @relation(fields: [userId], references: [id], onDelete: Cascade)
  game               Game                     @relation(fields: [appId], references: [appId], onDelete: Cascade)

  @@unique([userId, appId])
  @@map("user_games")
  @@index([userId])
  @@index([appId])
  @@index([playtimeMinutes])
}
